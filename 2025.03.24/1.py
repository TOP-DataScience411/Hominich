import numpy as np
import pandas as pd
from pathlib import Path

def load_year_value_file(path: Path) -> dict:
    """Чтение CSV-файла с двумя колонками: год и значение"""
    df = pd.read_csv(path, comment='#', sep=r'\s+', header=None, names=['year', 'value'])
    df = df.dropna()
    df['year'] = df['year'].astype(int)
    df['value'] = df['value'].astype(float)

    # Z-нормализация (среднее = 0, std = 1)
    mean = df['value'].mean()
    std = df['value'].std()
    df['normalized'] = (df['value'] - mean) / std

    return dict(zip(df['year'], df['normalized']))

def calculate_correlation_with_shift(dict1, dict2, max_shift=5):
    """Вычисляет корреляцию между двумя временными рядами с различными сдвигами"""
    years1 = sorted(dict1.keys())
    years2 = sorted(dict2.keys())

    all_shifts = range(-max_shift, max_shift + 1)

    for shift in all_shifts:
        if shift >= 0:
            common_years = [y for y in years1 if y + shift in years2]
            values1 = [dict1[y] for y in common_years]
            values2 = [dict2[y + shift] for y in common_years]
        else:
            common_years = [y for y in years2 if y - shift in years1]
            values1 = [dict1[y - shift] for y in common_years]
            values2 = [dict2[y] for y in common_years]

        if len(values1) >= 2:
            corr = np.corrcoef(values1, values2)[0, 1]
        else:
            corr = np.nan

        print("=" * 50)
        print(f"Сдвиг по времени: {shift:+} лет")
        print("Вариационный ряд 1:", list(np.round(values1, 4)))
        print("Вариационный ряд 2:", list(np.round(values2, 4)))
        print("Коэффициент корреляции:", f"{corr:.6f}" if not np.isnan(corr) else "Недостаточно данных")

# Пути к данным
science_path = Path("science_investetions.csv")
malignancy_path = Path("early_malignancy.csv")

# Загрузка и нормализация данных
science_data = load_year_value_file(science_path)
malignancy_data = load_year_value_file(malignancy_path)

# Анализ корреляции
calculate_correlation_with_shift(science_data, malignancy_data, max_shift=5)


# python3 1.py
# ==================================================
# Сдвиг по времени: -5 лет
# Вариационный ряд 1: [0.5951, 0.6288, 0.951, 1.0502, 1.38, 1.7961]
# Вариационный ряд 2: [-1.5337, -1.4403, -1.0666, -0.5372, -0.2258, 0.0545]
# Коэффициент корреляции: 0.965907
# ==================================================
# Сдвиг по времени: -4 лет
# Вариационный ряд 1: [0.3484, 0.5951, 0.6288, 0.951, 1.0502, 1.38, 1.7961]
# Вариационный ряд 2: [-1.5337, -1.4403, -1.0666, -0.5372, -0.2258, 0.0545, 0.3036]
# Коэффициент корреляции: 0.960551
# ==================================================
# Сдвиг по времени: -3 лет
# Вариационный ряд 1: [0.2856, 0.3484, 0.5951, 0.6288, 0.951, 1.0502, 1.38, 1.7961]
# Вариационный ряд 2: [-1.5337, -1.4403, -1.0666, -0.5372, -0.2258, 0.0545, 0.3036, 0.6151]
# Коэффициент корреляции: 0.959728
# ==================================================
# Сдвиг по времени: -2 лет
# Вариационный ряд 1: [0.0956, 0.2856, 0.3484, 0.5951, 0.6288, 0.951, 1.0502, 1.38, 1.7961]
# Вариационный ряд 2: [-1.5337, -1.4403, -1.0666, -0.5372, -0.2258, 0.0545, 0.3036, 0.6151, 0.2725]
# Коэффициент корреляции: 0.892257
# ==================================================
# Сдвиг по времени: -1 лет
# Вариационный ряд 1: [-0.2123, 0.0956, 0.2856, 0.3484, 0.5951, 0.6288, 0.951, 1.0502, 1.38, 1.7961]
# Вариационный ряд 2: [-1.5337, -1.4403, -1.0666, -0.5372, -0.2258, 0.0545, 0.3036, 0.6151, 0.2725, 0.7708]
# Коэффициент корреляции: 0.919659
# ==================================================
# Сдвиг по времени: +0 лет
# Вариационный ряд 1: [-0.3571, -0.2123, 0.0956, 0.2856, 0.3484, 0.5951, 0.6288, 0.951, 1.0502, 1.38, 1.7961]
# Вариационный ряд 2: [-1.5337, -1.4403, -1.0666, -0.5372, -0.2258, 0.0545, 0.3036, 0.6151, 0.2725, 0.7708, 1.2068]
# Коэффициент корреляции: 0.963763
# ==================================================
# Сдвиг по времени: +1 лет
# Вариационный ряд 1: [-0.6367, -0.3571, -0.2123, 0.0956, 0.2856, 0.3484, 0.5951, 0.6288, 0.951, 1.0502, 1.38, 1.7961]
# Вариационный ряд 2: [-1.5337, -1.4403, -1.0666, -0.5372, -0.2258, 0.0545, 0.3036, 0.6151, 0.2725, 0.7708, 1.2068, 1.5805]
# Коэффициент корреляции: 0.975617
# ==================================================
# Сдвиг по времени: +2 лет
# Вариационный ряд 1: [-0.8913, -0.6367, -0.3571, -0.2123, 0.0956, 0.2856, 0.3484, 0.5951, 0.6288, 0.951, 1.0502, 1.38]
# Вариационный ряд 2: [-1.5337, -1.4403, -1.0666, -0.5372, -0.2258, 0.0545, 0.3036, 0.6151, 0.2725, 0.7708, 1.2068, 1.5805]
# Коэффициент корреляции: 0.988307
# ==================================================
# Сдвиг по времени: +3 лет
# Вариационный ряд 1: [-0.9831, -0.8913, -0.6367, -0.3571, -0.2123, 0.0956, 0.2856, 0.3484, 0.5951, 0.6288, 0.951, 1.0502]
# Вариационный ряд 2: [-1.5337, -1.4403, -1.0666, -0.5372, -0.2258, 0.0545, 0.3036, 0.6151, 0.2725, 0.7708, 1.2068, 1.5805]
# Коэффициент корреляции: 0.983648
# Сдвиг по времени: +4 лет
# Вариационный ряд 1: [-1.1448, -0.9831, -0.8913, -0.6367, -0.3571, -0.2123, 0.0956, 0.2856, 0.3484, 0.5951, 0.6288, 0.951]
# Вариационный ряд 2: [-1.5337, -1.4403, -1.0666, -0.5372, -0.2258, 0.0545, 0.3036, 0.6151, 0.2725, 0.7708, 1.2068, 1.5805]
# Коэффициент корреляции: 0.982812
# ==================================================
# Сдвиг по времени: +5 лет
# Вариационный ряд 1: [-1.3317, -1.1448, -0.9831, -0.8913, -0.6367, -0.3571, -0.2123, 0.0956, 0.2856, 0.3484, 0.5951, 0.6288]
# Вариационный ряд 2: [-1.5337, -1.4403, -1.0666, -0.5372, -0.2258, 0.0545, 0.3036, 0.6151, 0.2725, 0.7708, 1.2068, 1.5805]
# Коэффициент корреляции: 0.968382
#
